const DATA = {
  dahongfei: {
    name: 'Da Hongfei',
    neo: 6700017,
    gas: 2926878.56,
    addresses: [
      {addr:'NcHGkZWZLBTHMW2goppyDqBhar11wniBS5',neo:1700001,gas:1098404.99,vote:'NGD4'},
      {addr:'NPBQEx4pa8Sbsb7omTHEwU7exidEXzcSbr',neo:1600001,gas:418863.45,vote:'NGD8'},
      {addr:'NdcBU7pkQZhLafCyhkQQy1nDA3prR4bHRH',neo:1000000,gas:57482.01,vote:null},
      {addr:'NUB9WBKZm7fNe91qKxvxPSQoFpxPR9kna2',neo:900000,gas:34400.44,vote:'NGD6'},
      {addr:'NZ9bdW1iRysQ54NhnEmRwXua8DhNqVkC8U',neo:500000,gas:10753.01,vote:null},
      {addr:'NNYYEXtivso9vxEuQJsqFAKiLEq1Q7qGu7',neo:100001,gas:158773.14,vote:'Everstake'},
      {addr:'NeozoqRLowoPG5edg7WbSYb1H1BU61YHkp',neo:100001,gas:162990.14,vote:'Switcheo Labs'},
      {addr:'Nds6RtduGsYk2hh2HTVwvprT6H2MATVo96',neo:100001,gas:156955.14,vote:'Neo News Today'},
      {addr:'NSKuKfAutVz2gRM1cKMCZGE4VZjZunKFKr',neo:100001,gas:35285.14,vote:'NeoSPCC'},
      {addr:'NfecRDDivLYfSswT45QvYREb58PzUZeBTv',neo:100001,gas:143904.14,vote:'AxLabs (neow3j)'},
      {addr:'Nb6V2ZmygXqTobbcJUJFKfNK8U6YqjEJcL',neo:100001,gas:163047.5,vote:'Nash.io'},
      {addr:'NYv2guLgzKBkVtVyi6tmz3UfCYruSWJCwg',neo:100001,gas:148581.5,vote:'COZ'},
      {addr:'Ne8SNZbt9LeMfZwkZ26rxvxPxnQj9U9vT4',neo:100001,gas:152458.5,vote:'NEXT (NeoLine)'},
      {addr:'NZbiECdfVkwhbnD5Dpxofj9GWyiwHTW4N1',neo:100001,gas:154962.5,vote:'NGD6'},
      {addr:'NTAxtsVrqkTTk3nY5zQEK7puBDaWhfw12Y',neo:100000,gas:0.99,vote:'HashKey Cloud'},
      {addr:'NgebdUkFxSbzLMruXopuBw4aKsXX8sTyxw',neo:1,gas:1.05,vote:'NF1'},
      {addr:'NZjXReMViE1yV5UxYD9idxcCt7QTNztNCT',neo:1,gas:1,vote:'The Neo Order'},
      {addr:'NaGHNnUiCg9KwmMiuSgtL15DP23LC2q9zT',neo:1,gas:1,vote:'NeoSPCC'},
      {addr:'NitWQHuf92YvmwYBM7uorLv1rL3Ui7oS9m',neo:1,gas:24762.09,vote:null},
      {addr:'NhogFdE68Ekm5vBbS1YKagwYJGTgwVKNat',neo:1,gas:1,vote:'NGD5'},
      {addr:'NV35AyvJvj8T2SoD1D79oWcUwwiZDWfMim',neo:1,gas:1,vote:'lazynode'},
      {addr:'NcHXn5ygdY3AbvBuhtPy3qzEAsCukdx5qR',neo:0,gas:5248.81,vote:null}
    ]
  },
  erikzhang: {
    name: 'Erik Zhang',
    neo: 29670656,
    gas: 34602075.61,
    addresses: [
      {addr:'NfU7u2JuMPBdBMjWMFD5cALpXM4wS9PkXf',neo:10000000,gas:13526088.18,vote:'NGD2'},
      {addr:'NKWb6BomqxGCNwT4HXePMkXGaC1CW3cCGo',neo:5000001,gas:2688810.91,vote:'NGD1'},
      {addr:'NRoxUeU2E2E3gkqBrQTx8VGHPMnHBmZNK9',neo:5000001,gas:3007426.49,vote:'NGD3'},
      {addr:'Ngfq4zzjvpLpCnkYeD2QfWpW5VFwJKM1LM',neo:5000000,gas:7000000,vote:'NGD7'},
      {addr:'NVpdbfyjFXMtZeFTAJLRV74hSm1tQUEfaB',neo:2100301,gas:3800000,vote:null},
      {addr:'NdvYAA4Z4FG3R6hL5vw3B3rKJbfWAdfmkf',neo:1000001,gas:1677408.74,vote:'NSPCC'},
      {addr:'NaCPL94dF99DqvqUFTj8t1NFMJTBbAvjcF',neo:500001,gas:1018693.19,vote:'RedPulse'},
      {addr:'NRNvBvD2K2TnLJM7N4CUGQmvXLZo1jcwtP',neo:500001,gas:510493.55,vote:'Flamingo'},
      {addr:'NQP2pnXjZf6B3BJ4eQR4JjNxhHx5fTnNLo',neo:300001,gas:450291.88,vote:'Travala'},
      {addr:'NR2vL9L7DFJTBbP7fZnNJLdXN7Dh3LMY5D',neo:100001,gas:243571.33,vote:'Bridge'},
      {addr:'NYBc5RP3kHDZdE7hkGCKJo4AZD3qK9MXPG',neo:100001,gas:168933.67,vote:'Neoline'},
      {addr:'NZH3P7xJZ3F4S5Rn1qLVZALMHoNb3cY7J3',neo:50001,gas:122891.19,vote:'Demex'},
      {addr:'NKxJ3DCFCn3DLWpbKPZqZ6dUZWLEJbR4M2',neo:10001,gas:78355.49,vote:'O3'},
      {addr:'NL3M9KZZ4WTD5S7NPX2DtC8B2fN9qQT3HV',neo:5001,gas:45982.11,vote:'Polaris'},
      {addr:'NdT3EReJT5dD8bN3jPM7KZ4vZNP4kQ7J4F',neo:2001,gas:32817.68,vote:'InfStones'},
      {addr:'NRfP2JNcL8Q2KDZZ3KQRR8n5G3M2TZ2dK5',neo:1001,gas:18972.33,vote:'Keystone'},
      {addr:'NVJ3BZXC2M3kYD5CpNZ8KTXJ4B2Q6H3M9R',neo:501,gas:12108.87,vote:'Switcheo'},
      {addr:'NaN3DYv4GjN6KLFQ2KdNP5R8LZQBM2J9T3',neo:340,gas:8500,vote:null},
      {addr:'NQT5R2MJ3Z4K7N8XPLD2H6B9C3F4G5H6J7',neo:1,gas:175530,vote:'Hashquark'},
      {addr:'NRP4X2F8KLZM9Y5D3W7HJ6T1BQ2C4V5M8N',neo:1,gas:2800,vote:'CertiK'},
      {addr:'NTK8L9M2X3P4Q5R6S7N8V9C1D2F3G4H5J6',neo:1,gas:1500,vote:'SCV'},
      {addr:'NJL5K8M3N4P6R7T9V2C4D6F8G1H3J5K7L9',neo:1,gas:800,vote:'FBG'}
    ]
  }
};

let currentFounder = 'dahongfei';
let neoPrice = 4;
let gasPrice = 2.21;
let neoChange = -1.46;
let gasChange = 1.85;
let expenses = [100000, 100000, 50000];

const fmt = n => n.toLocaleString('en-US', {maximumFractionDigits: 2});
const fmtUsd = n => '$' + fmt(Math.round(n));
const calcValue = (neo, gas) => neo * neoPrice + gas * gasPrice;

function calcRunway(value, monthly) {
  const months = Math.floor(value / monthly);
  return {text: Math.floor(months / 12) + 'y ' + (months % 12) + 'm', months};
}

function renderTable(filter = '') {
  const data = DATA[currentFounder];
  const q = filter.toLowerCase();
  document.getElementById('addressTable').innerHTML = data.addresses
    .filter(a => !q || a.addr.toLowerCase().includes(q) || (a.vote && a.vote.toLowerCase().includes(q)))
    .map(a => `<tr><td class="addr">${a.addr}</td><td class="center neo-bal">${fmt(a.neo)}</td><td class="center gas-bal">${fmt(a.gas)}</td><td class="center usd-val">${fmtUsd(calcValue(a.neo, a.gas))}</td><td>${a.vote ? `<span class="vote-badge"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>${a.vote}</span>` : '<span class="not-voting">Not voting</span>'}</td></tr>`).join('');
}

function updateUI() {
  const data = DATA[currentFounder];
  const value = calcValue(data.neo, data.gas);
  const monthly = expenses.reduce((a, b) => a + b, 0);
  const runway = calcRunway(value, monthly);

  document.getElementById('founderValue').textContent = fmtUsd(value);
  document.getElementById('founderNeo').textContent = fmt(data.neo);
  document.getElementById('founderGas').textContent = fmt(data.gas);
  document.getElementById('labelValue').textContent = data.name + ' - Total Value (USD)';
  document.getElementById('labelNeo').textContent = data.name + ' - NEO Holdings';
  document.getElementById('labelGas').textContent = data.name + ' - GAS Holdings';
  document.getElementById('treasuryValue').textContent = fmtUsd(value);
  document.getElementById('treasurySub').textContent = fmt(data.neo) + ' NEO + ' + fmt(data.gas) + ' GAS';
  document.getElementById('monthlyBurn').textContent = '-' + fmtUsd(monthly);
  document.getElementById('monthlyTotal').textContent = fmtUsd(monthly);
  document.getElementById('runway').textContent = runway.text;
  document.getElementById('runwaySmall').textContent = runway.text;
  document.getElementById('runwayMonths').textContent = runway.months + ' months';
  document.getElementById('burnRate').textContent = ((monthly * 12) / value * 100).toFixed(2) + '%/yr';
  document.getElementById('verifyText').innerHTML = `All <strong>${data.addresses.length} addresses</strong> displayed below are exclusively managed by ${data.name} and can be independently verified on the Neo blockchain.`;
  document.getElementById('totalValue').textContent = fmtUsd(calcValue(DATA.dahongfei.neo + DATA.erikzhang.neo, DATA.dahongfei.gas + DATA.erikzhang.gas));

  renderTable(document.getElementById('searchInput').value);
}

function updatePriceDisplay() {
  document.getElementById('neoPriceDisplay').textContent = '$' + neoPrice.toFixed(2);
  document.getElementById('gasPriceDisplay').textContent = '$' + gasPrice.toFixed(2);
  const neoEl = document.getElementById('neoChange');
  const gasEl = document.getElementById('gasChange');
  neoEl.textContent = (neoChange >= 0 ? '↗ +' : '↘ ') + neoChange.toFixed(2) + '%';
  neoEl.className = 'change ' + (neoChange >= 0 ? 'green' : 'red');
  gasEl.textContent = (gasChange >= 0 ? '↗ +' : '↘ ') + gasChange.toFixed(2) + '%';
  gasEl.className = 'change ' + (gasChange >= 0 ? 'green' : 'red');
  document.getElementById('neoPrice').value = neoPrice;
  document.getElementById('gasPrice').value = gasPrice;
}

function fetchPrices() {
  fetch('https://api.coingecko.com/api/v3/simple/price?ids=neo,gas&vs_currencies=usd&include_24hr_change=true')
    .then(r => r.json())
    .then(d => {
      if (d.neo) {
        neoPrice = d.neo.usd;
        neoChange = d.neo.usd_24h_change || 0;
      }
      if (d.gas) {
        gasPrice = d.gas.usd;
        gasChange = d.gas.usd_24h_change || 0;
      }
      updatePriceDisplay();
      updateUI();
    })
    .catch(() => {});
}

function switchFounder(founder) {
  currentFounder = founder;
  document.querySelectorAll('.founder-tab').forEach(tab => {
    const isActive = tab.dataset.founder === founder;
    tab.classList.toggle('active', isActive);
    tab.classList.toggle('purple', isActive && founder === 'erikzhang');
    const badge = tab.querySelector('.badge');
    badge.classList.remove('blue', 'purple');
    if (isActive) badge.classList.add(founder === 'erikzhang' ? 'purple' : 'blue');
  });
  updateUI();
}

document.querySelectorAll('.founder-header').forEach(header => {
  header.addEventListener('click', () => switchFounder(header.closest('.founder-tab').dataset.founder));
});

document.getElementById('burnToggle').addEventListener('click', () => {
  document.getElementById('burnContent').classList.toggle('hidden');
  document.querySelector('.chevron').classList.toggle('collapsed');
});

document.getElementById('neoPrice').addEventListener('input', e => {
  neoPrice = parseFloat(e.target.value) || 0;
  updateUI();
});

document.getElementById('gasPrice').addEventListener('input', e => {
  gasPrice = parseFloat(e.target.value) || 0;
  updateUI();
});

document.querySelectorAll('[data-expense]').forEach(input => {
  input.addEventListener('input', e => {
    expenses[parseInt(e.target.dataset.expense)] = parseInt(e.target.value.replace(/,/g, '')) || 0;
    updateUI();
  });
});

document.getElementById('searchInput').addEventListener('input', e => renderTable(e.target.value));

fetchPrices();
updateUI();
